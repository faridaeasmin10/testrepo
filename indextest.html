<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>পূর্ণাঙ্গ যাকাত ক্যালকুলেটর</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React and ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        /* =========================================
           1. CORE VARIABLES & FONTS
           ========================================= */
        @import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=Noto+Serif+Bengali:wght@400;500;600;700&display=swap');
        
        :root {
            --theme-color: #6aa84f;
            --theme-color-darker: #5a9042;
            --theme-color-focus-ring: rgba(106, 168, 79, 0.3);
            --bg-color: #F3F4F6;
            --card-bg: #FFFFFF;
            --text-main: #1F2937;
            --border-color: #D1D5DB;
        }

        body {
            font-family: 'DM Sans', 'Noto Serif Bengali', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            /* Reset padding for full mobile view, will handle in containers */
            margin: 0; 
        }

        /* =========================================
           2. COMPONENT STYLES
           ========================================= */

        /* Inputs */
        .input-style {
            font-family: inherit;
            background-color: #F9FAFB;
            color: #1F2937;
            border-radius: 9999px; /* Pill shape */
            border: 1px solid var(--border-color);
            padding: 0.8rem 1.5rem;
            width: 100%;
            display: block;
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .input-style:focus {
            border-color: var(--theme-color);
            box-shadow: 0 0 0 3px var(--theme-color-focus-ring);
        }

        /* Buttons */
        .btn-primary {
            background-color: var(--theme-color);
            color: white;
            font-weight: 500;
            border-radius: 9999px;
            padding: 0.5rem 1.5rem;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
        }
        .btn-primary:hover { background-color: var(--theme-color-darker); }
        .btn-primary:disabled { background-color: #9CA3AF; cursor: not-allowed; }

        /* Radio Pills */
        .radio-wrapper input { display: none; }
        .radio-pill {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            padding: 0.6rem 1.2rem;
            border-radius: 9999px;
            border: 1px solid var(--border-color);
            background-color: #F9FAFB;
            transition: all 0.2s;
            font-size: 0.9rem;
            width: 100%;
            text-align: center;
            height: 100%;
        }
        .radio-pill:hover { border-color: var(--theme-color); }
        .radio-wrapper input:checked + .radio-pill {
            background-color: var(--theme-color);
            color: white;
            border-color: var(--theme-color-darker);
        }

        /* NEW: Specific text color overrides for selected state */
        .radio-pill .pill-label { color: #9CA3AF; transition: color 0.2s; } /* text-gray-400 */
        .radio-pill .pill-value { color: #1F2937; transition: color 0.2s; } /* text-gray-800 */
        .radio-pill .pill-info { color: #9CA3AF; transition: color 0.2s; }  /* text-gray-400 */

        .radio-wrapper input:checked + .radio-pill .pill-label { color: rgba(255, 255, 255, 0.85); }
        .radio-wrapper input:checked + .radio-pill .pill-value { color: #FFFFFF; }
        .radio-wrapper input:checked + .radio-pill .pill-info { color: rgba(255, 255, 255, 0.8); }

        /* Containers */
        .card-container {
            background-color: var(--card-bg);
            padding: 1.5rem;
            border-radius: 2rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            margin-bottom: 1.5rem;
        }
        
        .result-box {
            background-color: #F9FAFB;
            border: 1px solid #E5E7EB;
            border-radius: 1rem;
            padding: 1.5rem;
        }

        /* Helpers */
        .label-text { color: #374151; font-weight: 500; font-size: 0.875rem; display: block; margin-bottom: 0.5rem; }
        .heading-text { color: #111827; font-weight: 600; }
        .secondary-text { color: #6B7280; font-size: 0.875rem; }
        .theme-text { color: var(--theme-color); }
        .theme-text-dark { color: var(--theme-color-darker); }

        .slide-in { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Mobile safe area */
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
        
        /* Utility */
        .bengali-font { font-family: 'Noto Serif Bengali', serif; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // Constants
        const GRAMS_PER_VORI = 11.664;
        const NISAB_GOLD_VORI = 7.5;
        const NISAB_SILVER_VORI = 52.5;

        // --- Helper Functions ---
        const toBengali = (str) => {
            if (str === null || str === undefined) return '';
            return str.toString().replace(/[0-9]/g, d => "০১২৩৪৫৬৭৮৯"[d]);
        };

        const parseBengaliToNumber = (str) => {
            if (!str) return 0;
            const englishStr = str.toString().replace(/[০-৯]/g, d => "০১২৩৪৫৬৭৮৯".indexOf(d)).replace(/,/g, '');
            const num = parseFloat(englishStr);
            return isNaN(num) ? 0 : num;
        };

        const getBengaliText = (num) => {
            if (!num || num < 1000) return '';
            if (num >= 10000000) { 
                const val = parseFloat((num / 10000000).toFixed(2));
                return toBengali(val) + ' কোটি';
            } else if (num >= 100000) { 
                const val = parseFloat((num / 100000).toFixed(2));
                return toBengali(val) + ' লক্ষ';
            } else if (num >= 1000) {
                const val = parseFloat((num / 1000).toFixed(2));
                return toBengali(val) + ' হাজার';
            }
            return '';
        };

        const formatMoney = (amount, currency = 'BDT') => {
            const formatted = new Intl.NumberFormat('en-IN', { 
                style: 'decimal', 
                minimumFractionDigits: 2, 
                maximumFractionDigits: 2 
            }).format(amount);
            const bengali = formatted.replace(/\d/g, d => "০১২৩৪৫৬৭৮৯"[d]);
            const symbol = currency === 'BDT' ? '৳' : currency;
            return `${symbol} ${bengali}`;
        };

        const formatDate = (date) => {
            if (!date) return '';
            const formatter = new Intl.DateTimeFormat('bn-BD', { 
                day: 'numeric', 
                month: 'long', 
                year: 'numeric'
            });
            return formatter.format(date);
        };

        // --- Icons ---
        const InfoIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>;
        const CalculatorIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="16" height="20" x="4" y="2" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/></svg>;
        const GoldIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M6 12h12"/><path d="M4 16h16"/><path d="M20 16a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2v-5c0-1.1.9-2 2-2h12a2 2 0 0 1 2 2z"/><path d="M4 8h16"/></svg>;
        const CashIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="20" height="14" x="2" y="5" rx="2"/><line x1="2" x2="22" y1="10" y2="10"/></svg>;
        const BusinessIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 21l1.65-3.8a2 2 0 0 1 1.95-1.2H21v-4"/><path d="M11 10V6.5a2.5 2.5 0 0 1 5 0V10"/><path d="M11 21v-6h5v6"/><path d="M2 10h20"/></svg>;
        const DebtIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 16v-4a4 4 0 0 0-4-4h-4"/><path d="M22 12H7a5 5 0 0 0 0 10h6"/><path d="M5 12V2M12 2v4"/></svg>;
        const RefreshIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 21h5v-5"/></svg>;
        const ChevronDown = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m6 9 6 6 6-6"/></svg>;
        const AlertIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>;

        const Tooltip = ({ text }) => (
            <div className="group relative inline-block ml-2 align-middle z-10">
                <span className="text-gray-400 hover:text-[var(--theme-color)] cursor-help"><InfoIcon /></span>
                <div className="invisible group-hover:visible absolute z-50 w-64 p-3 mt-2 -ml-32 text-xs text-white bg-gray-800 rounded-lg opacity-0 group-hover:opacity-100 transition-opacity duration-300 bottom-full left-1/2 mb-2 pointer-events-none text-left shadow-lg">
                    {text}
                    <div className="absolute left-1/2 top-full -translate-x-1/2 border-8 border-transparent border-t-gray-800"></div>
                </div>
            </div>
        );

        // --- Custom Components based on Style Guide ---

        const SectionHeader = ({ title, icon, total, isOpen, toggle }) => (
            <button 
                onClick={toggle}
                className={`w-full flex items-center justify-between p-4 bg-white border border-gray-100 hover:bg-gray-50 transition-colors ${isOpen ? 'rounded-t-[2rem] border-b-0' : 'rounded-lg shadow-sm'}`}
            >
                <div className="flex items-center gap-3">
                    <div className="p-2 bg-gray-100 text-[var(--theme-color-darker)] rounded-full shrink-0">
                        {icon}
                    </div>
                    <span className="heading-text text-lg">{title}</span>
                </div>
                <div className="flex items-center gap-3">
                    <span className="theme-text-dark font-bold hidden sm:inline bengali-font">{formatMoney(total, '')}</span>
                    <span className={`transform transition-transform text-gray-400 ${isOpen ? 'rotate-180' : ''}`}>
                        <ChevronDown />
                    </span>
                </div>
            </button>
        );

        // Updated InputRow to accept a custom suffix prop
        const InputRow = ({ label, value, onChange, placeholder, tooltip, suffix = "টাকা" }) => {
            const [localValue, setLocalValue] = useState("");

            useEffect(() => {
                const parsedLocal = parseBengaliToNumber(localValue);
                if (parsedLocal !== value) {
                    if (value === 0 && localValue === '') return;
                    const formatted = new Intl.NumberFormat('en-IN', { maximumFractionDigits: 10 }).format(value);
                    const bengaliFormatted = formatted.replace(/[0-9]/g, d => "০১২৩৪৫৬৭৮৯"[d]);
                    setLocalValue(bengaliFormatted);
                }
            }, [value]);

            const handleChange = (e) => {
                let val = e.target.value;
                let cleanVal = val.replace(/,/g, '');
                cleanVal = cleanVal.replace(/[0-9]/g, d => "০১২৩৪৫৬৭৮৯"[d]);
                const num = parseBengaliToNumber(cleanVal);
                onChange(num);

                const parts = cleanVal.split('.');
                let integerPart = parts[0];
                const decimalPart = parts.length > 1 ? '.' + parts[1] : '';
                integerPart = integerPart.replace(/[^\u09E6-\u09EF]/g, '');

                if (integerPart) {
                    const engIntStr = integerPart.replace(/[০-৯]/g, d => "০১২৩৪৫৬৭৮৯".indexOf(d));
                    const engInt = parseInt(engIntStr);
                    if (!isNaN(engInt)) {
                        const formattedEng = new Intl.NumberFormat('en-IN').format(engInt);
                        integerPart = formattedEng.replace(/[0-9]/g, d => "০১২৩৪৫৬৭৮৯"[d]);
                    }
                }
                setLocalValue(integerPart + decimalPart);
            };

            const wordHint = getBengaliText(value);

            return (
                <div className="mb-4">
                    <label className="label-text">
                        {label}
                        {tooltip && <Tooltip text={tooltip} />}
                    </label>
                    <div className="relative">
                        <input
                            type="text"
                            inputMode="decimal"
                            className="input-style text-lg bengali-font"
                            placeholder={placeholder ? toBengali(placeholder) : ''}
                            value={localValue}
                            onChange={handleChange}
                            style={{ paddingRight: '4rem' }} 
                        />
                         <div className="absolute inset-y-0 right-0 pr-4 flex items-center pointer-events-none">
                            <span className="text-gray-400 text-sm bengali-font">{suffix}</span>
                        </div>
                    </div>
                    {/* Only show word hint if the suffix is Taka (currency), not for weight */}
                    {suffix === "টাকা" && wordHint && (
                        <div className="text-right mt-1">
                            <span className="inline-block bg-gray-100 text-gray-600 text-xs px-2 py-0.5 rounded-full bengali-font font-medium">
                                {wordHint}
                            </span>
                        </div>
                    )}
                </div>
            );
        };

        const App = () => {
            const [currency, setCurrency] = useState('BDT');
            const [goldPrice, setGoldPrice] = useState(145000); 
            const [silverPrice, setSilverPrice] = useState(2500);
            const [nisabStandard, setNisabStandard] = useState('silver'); 
            const [isLoading, setIsLoading] = useState(false);
            const [fetchError, setFetchError] = useState(false);
            const [lastUpdated, setLastUpdated] = useState(null); // New state for timestamp
            const summaryRef = useRef(null);

            const [openSections, setOpenSections] = useState({
                cash: true, gold: false, business: false, investments: false, liabilities: false
            });

            const [assets, setAssets] = useState({
                cashInHand: 0, bankAccounts: 0, foreignCurrency: 0, goldWeight: 0, silverWeight: 0,
                businessStock: 0, businessCash: 0, moneyOwedToYou: 0, sharesValue: 0, pensionValue: 0, otherAssets: 0
            });

            const [liabilities, setLiabilities] = useState({
                immediateDebts: 0, taxDue: 0, loanInstallments: 0, mahr: 0, pastZakat: 0, businessPayables: 0, advancePayments: 0
            });

            // Translations
            const t = {
                title: "পূর্ণাঙ্গ যাকাত ক্যালকুলেটর",
                desc: "আপনার বার্ষিক যাকাতের পরিমাণ সঠিকভাবে গণনা করার জন্য একটি পূর্ণাঙ্গ টুল।",
                settings: "১. সেটিংস এবং নিসাব",
                currency: "মুদ্রা",
                nisabStd: "নিসাব মানদণ্ড",
                nisabTooltip: "রৌপ্য মানদণ্ড গরিবদের জন্য অধিক নিরাপদ। স্বর্ণ মানদণ্ড ব্যবহার করুন যদি আপনার কাছে কেবল স্বর্ণ থাকে।",
                silver: "রৌপ্য",
                gold: "স্বর্ণ",
                goldPrice: "বর্তমান স্বর্ণের দাম (প্রতি ভরি)",
                goldTooltip: "২২/২৪ ক্যারেট স্বর্ণের স্থানীয় বাজার দর (প্রতি ভরি) লিখুন।",
                silverPrice: "বর্তমান রৌপ্যের দাম (প্রতি ভরি)",
                silverTooltip: "স্থানীয় বাজারের রৌপ্যের দর (প্রতি ভরি) লিখুন।",
                assetsTitle: "২. আপনার যাকাতযোগ্য সম্পদ",
                cashTitle: "নগদ এবং সঞ্চয়",
                cashHand: "হাতে থাকা নগদ / বাসায়",
                bankAcc: "ব্যাংক অ্যাকাউন্ট (সেভিংস/কারেন্ট)",
                foreignCurr: "বৈদেশিক মুদ্রার মান",
                preciousTitle: "স্বর্ণ এবং রৌপ্য",
                goldWt: "স্বর্ণের ওজন (ভরি)",
                goldWtTooltip: "মোট ওজন ভরিতে লিখুন (১ ভরি = ১১.৬৬৪ গ্রাম)।",
                silverWt: "রৌপ্যের ওজন (ভরি)",
                silverWtTooltip: "মোট ওজন ভরিতে লিখুন।",
                currVal: "বর্তমান মান",
                bizTitle: "ব্যবসা এবং বিনিয়োগ",
                bizStock: "ব্যবসায়িক পণ্য/মজুদের মান",
                bizStockTooltip: "বিক্রয়ের উদ্দেশ্যে রাখা পণ্যের বর্তমান পাইকারি বাজার মূল্য।",
                bizCash: "ব্যবসায়িক নগদ অর্থ / রিটেইন্ড আর্নিংস",
                owedToYou: "আপনার পাওনা টাকা (ফেরত পাওয়ার সম্ভাবনা আছে)",
                owedTooltip: "যে ঋণ ফেরত পাওয়ার ব্যাপারে আপনি নিশ্চিত।",
                shares: "শেয়ার / স্টক / ক্রিপ্টো",
                sharesTooltip: "ট্রেডিংয়ের জন্য: পুরো মান। দীর্ঘমেয়াদী ডিভিডেন্ডের জন্য: শুধুমাত্র যাকাতযোগ্য সম্পদের %।",
                pension: "পেনশন / অবসর তহবিল",
                pensionTooltip: "সাধারণত যে অংশটি উত্তোলনযোগ্য বা অ্যাক্সেসযোগ্য।",
                otherInv: "অন্যান্য বিনিয়োগ (রিয়েল এস্টেট - পুনঃবিক্রয়ের জন্য)",
                liabTitle: "৩. বাদযোগ্য ঋণসমূহ",
                debtTitle: "আপনার দেনাসমূহ",
                personalLiab: "ব্যক্তিগত ঋণ",
                immDebt: "তাৎক্ষণিক ঋণ (ক্রেডিট কার্ড/বিল)",
                immDebtTooltip: "বর্তমানে বকেয়া এবং পরিশোধযোগ্য ঋণ।",
                taxDue: "বকেয়া কর",
                longTerm: "দীর্ঘমেয়াদী ঋণ (১২ মাসের কিস্তি)",
                longTermTooltip: "গৃহঋণ বা অন্যান্য ঋণের শুধুমাত্র আগামী এক বছরের মূলধন পরিশোধের অংশ।",
                mahr: "মোহরানা (তাৎক্ষণিক প্রদেয়)",
                mahrTooltip: "স্ত্রীর দাবিকৃত বা তাৎক্ষণিকভাবে পরিশোধযোগ্য মোহরানা।",
                pastZakat: "বিগত বছরের অপরিশোধিত যাকাত",
                pastZakatTooltip: "বিগত বছরগুলোতে যাকাত না দিয়ে থাকলে তা আল্লাহর কাছে ঋণ।",
                bizLiab: "ব্যবসায়িক দায়",
                bizPay: "ব্যবসায়িক বকেয়া (বেতন/বিল)",
                bizPayTooltip: "কর্মচারীদের বকেয়া বেতন, ভাড়া বা সরবরাহকারীর বকেয়া বিল।",
                advPay: "অগ্রিম গ্রহণ (কাজ সম্পন্ন হয়নি)",
                advPayTooltip: "কাজের জন্য অগ্রিম নেওয়া টাকা যা কাজ না হলে ফেরত দিতে হবে।",
                summaryTitle: "যাকাতের সারাংশ",
                eligible: "আলহামদুলিল্লাহ, আপনি যাকাত প্রদানের যোগ্য।",
                eligibleNote: "আপনার নিট সম্পদ বর্তমান নিসাব সীমার উপরে।",
                totalDue: "মোট প্রদেয় যাকাত (২.৫%)",
                notEligible: "বর্তমানে আপনার উপর যাকাত ফরজ নয়।",
                notEligibleNote: "আপনার নিট সম্পদ বর্তমান নিসাব সীমার নিচে।",
                calcBreakdown: "গণনার বিশ্লেষণ",
                assetGroup: "সম্পদ গ্রুপ",
                deductLiab: "বাদযোগ্য ঋণ",
                netWealth: "নিট যাকাতযোগ্য সম্পদ",
                vsNisab: "বনাম নিসাব সীমা",
                footer1: "গণনাটি চন্দ্র বছরের ভিত্তিতে ২.৫% হারে করা হয়েছে।",
                footer2: "জটিল আর্থিক পরিস্থিতির জন্য অনুগ্রহ করে একজন আলেম বা মুফতির পরামর্শ নিন।"
            };

            const toggleSection = (section) => {
                setOpenSections(prev => ({...prev, [section]: !prev[section]}));
            };

            const updateAsset = (key, value) => {
                setAssets(prev => ({...prev, [key]: value}));
            };

            const updateLiability = (key, value) => {
                setLiabilities(prev => ({...prev, [key]: value}));
            };

            const fetchLiveRates = async (manualTrigger = false) => {
                setIsLoading(true);
                setFetchError(false);
                try {
                    const currencyLower = currency.toLowerCase();
                    const response = await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=pax-gold,kinesis-silver&vs_currencies=${currencyLower}`, {
                        method: 'GET',
                        headers: { 'Accept': 'application/json' }
                    });
                    
                    if (!response.ok) throw new Error("API Limit or Network Error");

                    const data = await response.json();

                    if (data['pax-gold'] && data['pax-gold'][currencyLower]) {
                        const pricePerOz = data['pax-gold'][currencyLower];
                        const pricePerGram = pricePerOz / 31.1035;
                        const pricePerVori = pricePerGram * GRAMS_PER_VORI;
                        setGoldPrice(parseFloat(pricePerVori.toFixed(2)));
                    }

                    if (data['kinesis-silver'] && data['kinesis-silver'][currencyLower]) {
                        const pricePerOzSilver = data['kinesis-silver'][currencyLower];
                        const pricePerGramSilver = pricePerOzSilver / 31.1035;
                        const pricePerVoriSilver = pricePerGramSilver * GRAMS_PER_VORI;
                        setSilverPrice(parseFloat(pricePerVoriSilver.toFixed(2)));
                    }
                    
                    // Set current timestamp on success
                    setLastUpdated(new Date());

                } catch (error) {
                    console.warn("Rate fetch failed:", error);
                    setFetchError(true);
                } finally {
                    setIsLoading(false);
                }
            };

            useEffect(() => {
                fetchLiveRates(false);
            }, []);

            // Calculations
            const goldValue = assets.goldWeight * goldPrice;
            const silverValue = assets.silverWeight * silverPrice;
            const totalCash = assets.cashInHand + assets.bankAccounts + assets.foreignCurrency;
            const totalBusiness = assets.businessStock + assets.businessCash + assets.moneyOwedToYou;
            const totalInvestments = assets.sharesValue + assets.pensionValue + assets.otherAssets;
            const totalPreciousMetals = goldValue + silverValue;
            const totalAssets = totalCash + totalBusiness + totalInvestments + totalPreciousMetals;
            const totalLiabilities = liabilities.immediateDebts + liabilities.taxDue + liabilities.loanInstallments + liabilities.mahr + liabilities.pastZakat + liabilities.businessPayables + liabilities.advancePayments;
            const netWealth = totalAssets - totalLiabilities;
            const goldNisabThreshold = NISAB_GOLD_VORI * goldPrice;
            const silverNisabThreshold = NISAB_SILVER_VORI * silverPrice;
            const currentNisab = nisabStandard === 'gold' ? goldNisabThreshold : silverNisabThreshold;
            const isEligible = netWealth >= currentNisab;
            const zakatDue = isEligible ? (netWealth * 0.025) : 0;

            const scrollToSummary = () => {
                if (summaryRef.current) {
                    summaryRef.current.scrollIntoView({ behavior: 'smooth' });
                }
            };

            return (
                <div className="min-h-screen pb-32 lg:pb-12 bg-[#F3F4F6]">
                    {/* Header */}
                    <div style={{ backgroundColor: 'var(--theme-color)' }} className="text-white py-6 lg:py-8 px-4 shadow-lg">
                        <div className="max-w-7xl mx-auto">
                            <div className="flex items-center gap-3 mb-2">
                                <CalculatorIcon />
                                <h1 className="text-2xl lg:text-3xl font-bold heading-text text-white">{t.title}</h1>
                            </div>
                            <p className="text-white opacity-90 text-sm lg:text-base bengali-font">{t.desc}</p>
                        </div>
                    </div>

                    <div className="max-w-7xl mx-auto mt-8 px-4 lg:flex lg:gap-8 items-start">
                        
                        {/* LEFT COLUMN: Inputs */}
                        <div className="flex-1 space-y-6">
                            {/* Settings Card */}
                            <div className="card-container">
                                <div className="flex justify-between items-center mb-6 border-b border-gray-100 pb-4">
                                    <h2 className="heading-text text-lg">{t.settings}</h2>
                                    <div className="flex items-center gap-2">
                                        {fetchError && (
                                            <span className="text-xs text-red-500 font-medium flex items-center gap-1">
                                                <AlertIcon /> আপডেট ব্যর্থ
                                            </span>
                                        )}
                                        <button 
                                            onClick={() => fetchLiveRates(true)} 
                                            disabled={isLoading}
                                            className="btn-primary"
                                            style={{ fontSize: '0.75rem', padding: '0.4rem 1rem' }}
                                        >
                                            <RefreshIcon />
                                            <span className="ml-1">{isLoading ? "আপডেট হচ্ছে..." : "লাইভ রেট আপডেট"}</span>
                                        </button>
                                    </div>
                                </div>

                                <div className="grid grid-cols-1 gap-6">
                                    {/* Market Rates Display (Read-Only) */}
                                    <div className="bg-gray-50 rounded-2xl p-5 border border-gray-200 grid grid-cols-1 sm:grid-cols-2 gap-6 relative overflow-hidden">
                                        <div className="absolute top-0 right-0 bg-gray-200 text-gray-600 text-[10px] px-2 py-1 rounded-bl-lg font-bold uppercase tracking-wider flex items-center gap-1">
                                            <span>লাইভ রেট</span>
                                            {lastUpdated && <span>• {formatDate(lastUpdated)}</span>}
                                        </div>
                                        
                                        <div className="flex items-center gap-4">
                                            <div className="p-3 bg-yellow-100 text-yellow-700 rounded-full shadow-sm">
                                                <GoldIcon />
                                            </div>
                                            <div>
                                                <p className="text-xs text-gray-500 uppercase font-bold tracking-wide mb-1">স্বর্ণের দাম (প্রতি ভরি)</p>
                                                <p className="text-xl font-bold theme-text-dark bengali-font leading-none">{formatMoney(goldPrice)}</p>
                                            </div>
                                        </div>

                                        <div className="flex items-center gap-4 sm:border-l sm:border-gray-200 sm:pl-6">
                                            <div className="p-3 bg-gray-200 text-gray-600 rounded-full shadow-sm">
                                                <div className="w-5 h-5 flex items-center justify-center font-serif font-bold text-xs">Ag</div>
                                            </div>
                                            <div>
                                                <p className="text-xs text-gray-500 uppercase font-bold tracking-wide mb-1">রৌপ্যের দাম (প্রতি ভরি)</p>
                                                <p className="text-xl font-bold theme-text-dark bengali-font leading-none">{formatMoney(silverPrice)}</p>
                                            </div>
                                        </div>
                                    </div>

                                    {/* Nisab Selection */}
                                    <div>
                                        <label className="label-text mb-3">
                                            {t.nisabStd}
                                            <Tooltip text={t.nisabTooltip} />
                                        </label>
                                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                            <label className="radio-wrapper h-full">
                                                <input type="radio" name="nisab" checked={nisabStandard === 'silver'} onChange={() => setNisabStandard('silver')} />
                                                <div className="radio-pill flex-col py-3 items-start pl-8 pr-6">
                                                    <span className="pill-label block text-xs uppercase tracking-wider font-bold mb-1">{t.silver}</span>
                                                    <span className="pill-value block text-lg font-bold bengali-font">{formatMoney(silverNisabThreshold)}</span>
                                                    <span className="pill-info text-[10px] mt-1 bengali-font">৫২.৫ ভরি × {formatMoney(silverPrice)}</span>
                                                </div>
                                            </label>
                                            <label className="radio-wrapper h-full">
                                                <input type="radio" name="nisab" checked={nisabStandard === 'gold'} onChange={() => setNisabStandard('gold')} />
                                                <div className="radio-pill flex-col py-3 items-start pl-8 pr-6">
                                                    <span className="pill-label block text-xs uppercase tracking-wider font-bold mb-1">{t.gold}</span>
                                                    <span className="pill-value block text-lg font-bold bengali-font">{formatMoney(goldNisabThreshold)}</span>
                                                    <span className="pill-info text-[10px] mt-1 bengali-font">৭.৫ ভরি × {formatMoney(goldPrice)}</span>
                                                </div>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* Assets Section */}
                            <div className="space-y-4">
                                <h2 className="heading-text text-xl px-1">{t.assetsTitle}</h2>

                                <div className="card-container !p-0 overflow-hidden">
                                    <SectionHeader 
                                        title={t.cashTitle} 
                                        icon={<CashIcon />} 
                                        total={totalCash} 
                                        isOpen={openSections.cash} 
                                        toggle={() => toggleSection('cash')} 
                                    />
                                    {openSections.cash && (
                                        <div className="p-6 pt-2 border-x border-b border-gray-100 rounded-b-[2rem] slide-in grid grid-cols-1 md:grid-cols-2 gap-6 bg-white">
                                            <InputRow label={t.cashHand} value={assets.cashInHand} onChange={(v) => updateAsset('cashInHand', v)} />
                                            <InputRow label={t.bankAcc} value={assets.bankAccounts} onChange={(v) => updateAsset('bankAccounts', v)} />
                                            <InputRow label={t.foreignCurr} value={assets.foreignCurrency} onChange={(v) => updateAsset('foreignCurrency', v)} />
                                        </div>
                                    )}
                                </div>

                                <div className="card-container !p-0 overflow-hidden">
                                    <SectionHeader 
                                        title={t.preciousTitle} 
                                        icon={<GoldIcon />} 
                                        total={totalPreciousMetals} 
                                        isOpen={openSections.gold} 
                                        toggle={() => toggleSection('gold')} 
                                    />
                                    {openSections.gold && (
                                        <div className="p-6 pt-2 border-x border-b border-gray-100 rounded-b-[2rem] slide-in grid grid-cols-1 md:grid-cols-2 gap-6 bg-white">
                                            <InputRow label={t.goldWt} value={assets.goldWeight} onChange={(v) => updateAsset('goldWeight', v)} tooltip={t.goldWtTooltip} suffix="ভরি" />
                                            <InputRow label={t.silverWt} value={assets.silverWeight} onChange={(v) => updateAsset('silverWeight', v)} tooltip={t.silverWtTooltip} suffix="ভরি" />
                                            <div className="col-span-1 md:col-span-2 text-sm secondary-text bg-gray-50 p-4 rounded-xl bengali-font border border-gray-100">
                                                {t.currVal}: {t.gold} {formatMoney(goldValue)} + {t.silver} {formatMoney(silverValue)}
                                            </div>
                                        </div>
                                    )}
                                </div>

                                <div className="card-container !p-0 overflow-hidden">
                                    <SectionHeader 
                                        title={t.bizTitle} 
                                        icon={<BusinessIcon />} 
                                        total={totalBusiness + totalInvestments} 
                                        isOpen={openSections.business} 
                                        toggle={() => toggleSection('business')} 
                                    />
                                    {openSections.business && (
                                        <div className="p-6 pt-2 border-x border-b border-gray-100 rounded-b-[2rem] slide-in grid grid-cols-1 md:grid-cols-2 gap-6 bg-white">
                                            <InputRow label={t.bizStock} value={assets.businessStock} onChange={(v) => updateAsset('businessStock', v)} tooltip={t.bizStockTooltip} />
                                            <InputRow label={t.bizCash} value={assets.businessCash} onChange={(v) => updateAsset('businessCash', v)} />
                                            <InputRow label={t.owedToYou} value={assets.moneyOwedToYou} onChange={(v) => updateAsset('moneyOwedToYou', v)} tooltip={t.owedTooltip} />
                                            <InputRow label={t.shares} value={assets.sharesValue} onChange={(v) => updateAsset('sharesValue', v)} tooltip={t.sharesTooltip} />
                                            <InputRow label={t.pension} value={assets.pensionValue} onChange={(v) => updateAsset('pensionValue', v)} tooltip={t.pensionTooltip} />
                                            <InputRow label={t.otherInv} value={assets.otherAssets} onChange={(v) => updateAsset('otherAssets', v)} />
                                        </div>
                                    )}
                                </div>
                            </div>

                            {/* Liabilities */}
                            <div className="space-y-4">
                                <h2 className="heading-text text-xl px-1">{t.liabTitle}</h2>
                                <div className="card-container !p-0 overflow-hidden">
                                    <SectionHeader 
                                        title={t.debtTitle} 
                                        icon={<DebtIcon />} 
                                        total={totalLiabilities} 
                                        isOpen={openSections.liabilities} 
                                        toggle={() => toggleSection('liabilities')} 
                                    />
                                    {openSections.liabilities && (
                                        <div className="p-6 pt-2 border-x border-b border-gray-100 rounded-b-[2rem] slide-in bg-white">
                                            <h4 className="text-sm font-semibold theme-text-dark mb-4 uppercase tracking-wider border-b border-gray-100 pb-1">{t.personalLiab}</h4>
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                                                <InputRow label={t.immDebt} value={liabilities.immediateDebts} onChange={(v) => updateLiability('immediateDebts', v)} tooltip={t.immDebtTooltip} />
                                                <InputRow label={t.taxDue} value={liabilities.taxDue} onChange={(v) => updateLiability('taxDue', v)} />
                                                <InputRow label={t.longTerm} value={liabilities.loanInstallments} onChange={(v) => updateLiability('loanInstallments', v)} tooltip={t.longTermTooltip} />
                                                <InputRow label={t.mahr} value={liabilities.mahr} onChange={(v) => updateLiability('mahr', v)} tooltip={t.mahrTooltip} />
                                                <InputRow label={t.pastZakat} value={liabilities.pastZakat} onChange={(v) => updateLiability('pastZakat', v)} tooltip={t.pastZakatTooltip} />
                                            </div>

                                            <h4 className="text-sm font-semibold theme-text-dark mb-4 uppercase tracking-wider border-b border-gray-100 pb-1">{t.bizLiab}</h4>
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                                 <InputRow label={t.bizPay} value={liabilities.businessPayables} onChange={(v) => updateLiability('businessPayables', v)} tooltip={t.bizPayTooltip} />
                                                 <InputRow label={t.advPay} value={liabilities.advancePayments} onChange={(v) => updateLiability('advancePayments', v)} tooltip={t.advPayTooltip} />
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>

                        </div> {/* End Left Column */}

                        {/* RIGHT COLUMN: Summary (Sticky Desktop / Bottom Block Mobile) */}
                        <div ref={summaryRef} className="lg:w-96 shrink-0 mt-8 lg:mt-0 lg:sticky lg:top-6" id="summary-section">
                            
                            {/* Summary Card */}
                            <div className="card-container !p-0 overflow-hidden border border-gray-200">
                                <div className="p-6 pb-4">
                                    <h2 className="text-xl font-bold heading-text mb-6 text-center">{t.summaryTitle}</h2>
                                    
                                    {/* Main Status Indicator */}
                                    <div className={`p-6 rounded-2xl text-center mb-6 transition-colors ${isEligible ? 'bg-green-50 border border-green-100' : 'bg-gray-50 border border-gray-200'}`}>
                                        {isEligible ? (
                                            <div>
                                                <p className="theme-text-dark font-medium mb-1">{t.eligible}</p>
                                                <p className="text-sm theme-text mb-3">{t.eligibleNote}</p>
                                                <div className="text-4xl font-bold theme-text-dark my-4 bengali-font">
                                                    {formatMoney(zakatDue)}
                                                </div>
                                                <p className="text-xs theme-text uppercase tracking-wide font-bold">{t.totalDue}</p>
                                            </div>
                                        ) : (
                                            <div>
                                                <p className="text-gray-700 font-medium">{t.notEligible}</p>
                                                <p className="text-sm text-gray-500 mt-1">{t.notEligibleNote}</p>
                                            </div>
                                        )}
                                    </div>
                                </div>

                                {/* Detailed Breakdown Table (Result Box Style) */}
                                <div className="result-box rounded-t-none border-x-0 border-b-0 border-t bg-[#F9FAFB]">
                                    <h3 className="font-semibold text-gray-700 border-b border-gray-200 pb-2 mb-4 text-sm">{t.calcBreakdown}</h3>
                                    
                                    <div className="space-y-3 text-sm">
                                        <div className="flex justify-between items-center text-gray-600">
                                            <div className="flex items-center gap-2"><div className="w-2 h-2 rounded-full bg-blue-400"></div>{t.cashTitle}</div>
                                            <span className="bengali-font font-medium">+ {formatMoney(totalCash)}</span>
                                        </div>
                                        <div className="flex justify-between items-center text-gray-600">
                                            <div className="flex items-center gap-2"><div className="w-2 h-2 rounded-full bg-yellow-400"></div>{t.preciousTitle}</div>
                                            <span className="bengali-font font-medium">+ {formatMoney(totalPreciousMetals)}</span>
                                        </div>
                                        <div className="flex justify-between items-center text-gray-600">
                                            <div className="flex items-center gap-2"><div className="w-2 h-2 rounded-full bg-purple-400"></div>{t.bizTitle}</div>
                                            <span className="bengali-font font-medium">+ {formatMoney(totalBusiness + totalInvestments)}</span>
                                        </div>
                                        <div className="flex justify-between font-bold heading-text pt-2 border-t border-gray-200 mt-2">
                                            <span className="pl-4">{t.assetsTitle}</span>
                                            <span className="bengali-font">{formatMoney(totalAssets)}</span>
                                        </div>

                                        <div className="flex justify-between items-center text-gray-600 mt-3">
                                            <div className="flex items-center gap-2"><div className="w-2 h-2 rounded-full bg-red-400"></div>{t.deductLiab}</div>
                                            <span className="text-red-500 bengali-font font-medium">- {formatMoney(totalLiabilities)}</span>
                                        </div>

                                        <div className="flex justify-between font-bold heading-text pt-3 border-t-2 border-gray-200 mt-3 text-base">
                                            <span>{t.netWealth}</span>
                                            <span className="bengali-font">{formatMoney(netWealth)}</span>
                                        </div>

                                        {/* Nisab Comparison */}
                                        <div className="mt-4 p-4 bg-indigo-50 border border-indigo-100 rounded-xl">
                                            <div className="flex justify-between items-center mb-1">
                                                <span className="text-xs font-bold text-indigo-800 uppercase tracking-wide">{t.vsNisab} ({nisabStandard})</span>
                                            </div>
                                            <div className="flex justify-between items-end">
                                                <span className="text-xs text-indigo-600">সর্বনিম্ন সীমা</span>
                                                <span className="text-lg font-bold text-indigo-700 bengali-font">{formatMoney(currentNisab)}</span>
                                            </div>
                                        </div>
                                        
                                        {/* Final Calculation Note */}
                                        {isEligible && (
                                            <div className="flex justify-end items-center gap-2 text-sm theme-text-dark pt-3 border-t border-dashed border-gray-300 mt-3">
                                                <span className="bengali-font">{formatMoney(netWealth)} × ২.৫% = </span>
                                                <span className="font-bold text-lg bengali-font">{formatMoney(zakatDue)}</span>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>

                            {/* Footer Info */}
                            <div className="text-center text-xs text-gray-400 mt-6 pb-8 bengali-font">
                                <p>{t.footer1.replace('2.5%', '২.৫%')}</p>
                                <p className="mt-1">{t.footer2}</p>
                            </div>

                        </div> {/* End Right Column */}
                    </div>

                    {/* MOBILE STICKY SUMMARY BAR (Only visible on lg:hidden) */}
                    <div className="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] lg:hidden z-40 safe-area-bottom">
                        <div className="px-4 py-3 flex justify-between items-center max-w-7xl mx-auto">
                            <div className="flex flex-col">
                                <span className="text-[10px] secondary-text uppercase tracking-wider font-bold">মোট প্রদেয় যাকাত</span>
                                <span className={`text-xl font-bold bengali-font ${isEligible ? 'theme-text-dark' : 'text-gray-400'}`}>
                                    {formatMoney(zakatDue)}
                                </span>
                            </div>
                            <button 
                                onClick={scrollToSummary}
                                className="btn-primary"
                                style={{ padding: '0.6rem 1.2rem' }}
                            >
                                <span>বিস্তারিত</span>
                                <ChevronDown />
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
